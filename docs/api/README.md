---
order: 2
toc: 'menu'
title: 'API'
nav:
  title: 'API'
  order: 2
---

# API

## `@dollie/core`

### Types & Interfaces

#### `MessageHandler`

Receives and handle messages from the Dollie context.

```typescript
type MessageHandler = (message: string) => void;
```

#### `ErrorHandler`

```typescript
type ErrorHandler = (error: Error) => void;
```

#### `InquirerAnswers`

Inquirer question answer format.

```typescript
type InquirerAnswers = Record<string, any>;
```

#### `LoaderConfig`

Dollie loader configuration to pass to the `Got` instance.

```typescript
interface HttpOptions {
    // HTTP local proxy URL
    httpProxyUrl?: string;
    // if the local agent requires authentication, specify this option
    httpProxyAuth?: string;
}

interface LoaderOptions extends HttpOptions {
    // maximum number of retries
    maximumRetryCount?: number;
}

type LoaderConfig = LoaderOptions & GotOptions;
```

#### `GeneratorConfig`

Dollie `Generator` configuration.

```typescript
interface GeneratorConfig {
    // origin configuration
    origin?: OriginConfig;
    // origin functions list
    origins?: Origin[];
    // loader configuration for pulling templates, reading custom Origin functions, etc.
    loader?: LoaderConfig;
    // get answers to template questions from users
    getTemplateProps?: (questions: Question[]) => Promise<InquirerAnswers>;
    // report conflicts to users and obtain conflict resolution
    conflictsSolver?: (data: ConflictSolverData) => Promise<ConflictSolveResult>;
    // receive and process messages from the Dollie context
    onMessage?: MessageHandler;
}
```

Depended types:

- [`MessageHandler`](/api#messagehandler)
- [`InquirerAnswers`](/api#dollieanswers)
- [`LoaderConfig`](/api#loaderconfig)
- [`ConflictSolveResult`](/api#conflictresolveresult)
- [`ConflictSolverData`](/api#conflictresolverdata)
- [`OriginConfig`](/api#dollieoriginconfig)
- [`Origin`](/api#dollieorigin)

#### `Config`

Dollie `Context` configuration.

```typescript
interface Config {
    // `Generator` configuration
    generator?: GeneratorConfig;
    // life cycle state change receiving function
    onStatusChange?: StatusChangeHandler;
    // error message receiving function
    onError?: ErrorHandler;
    // general message receiving functions
    onMessage?: MessageHandler;
}
```

Depended typs:

- [`GeneratorConfig`](/api#dolliegeneratorconfig)
- [`StatusChangeHandler`](/api#statuschangehandler)
- [`ErrorHandler`](/api#errorhandler)
- [`MessageHandler`](/api#messagehandler)

#### `StatusChangeHandler`

Contextual runtime state change receiving function.

```typescript
type StatusChangeHandler = (status: ContextStatusMap) => void;
```

Depended type:

- [`ContextStatusMap`](/api#dolliecontextstatusmap)

#### `ContextStatusMap`

Contextual lifecycle function execution status table, the key is the lifecycle function name, the value is the contextual runtime status.

```typescript
interface ContextStatusMap {
    [key: string]: ContextStatus;
}
```

Depended types:

- [`ContextStatus`](/api#dolliecontextstatus)

#### `ContextStatus`

Contextual runtime state:

- `pending`: waiting for executing
- `running`: executing
- `finished`: execution finished

```typescript
type ContextStatus = 'pending' | 'running' | 'finished';
```

#### `MergeBlock`

```typescript
interface MergeBlock {
    // `OK` means no conflict, `CONFLICT` means there is a conflict
    status: 'OK' | 'CONFLICT';
    values: {
        former: string[],
        current: string[],
    };
    // if ignored by the user, this value is `true`
    ignored?: boolean;
}
```

#### `ConflictResolverData`

Conflict data provided by the Dollie context to the user agent.

```typescript
interface ConflictBlockMetadata {
    // file path
    pathname: string;
    // the index of this conflict in the current file
    index: number;
}

interface ConflictSolverData extends ConflictBlockMetadata {
    // conflict block
    block: MergeBlock;
    // content of conflicted file
    content: string;
    // conflicts count in this file
    total: number;
}
```

Depended types:

- [`MergeBlock`](/api#mergeblock)

#### `ConflictResolveResult`

The conflict resolution returned by the user after handling the conflict.

- `MergeBlock`: The result after resolving conflicts for `block` in `ConflictSolverData`.

```typescript
type ConflictSolveResult = MergeBlock | 'ignored' | null;
```

#### `GeneratorResult`

Result generated by the Dollie generator.

```typescript
interface GeneratorResult {
    // A list of files, with key name as file path and value as file content.
    // If it is a text file, the value is of type string, if it is a binary file, the value is of type Buffer
    files: Record<string, string | Buffer>;
    // path to all files whose conflicts are ignored
    conflicts: string[];
}
```

#### `DiffChange`

Records the diff data generated by Dollie when merging changes to the same file.

```typescript
interface Change {
    count?: number;
    value: string;
    added?: boolean;
    removed?: boolean;
}

interface DiffChange extends Change {
    conflicted?: boolean;
    conflictGroup?: 'former' | 'current';
    lineNumber: number;
}
```

### `Context`

#### `constructor(projectName: string, templateOriginName: string, config: Config)`

The constructor of Dollie `Context`, when instantiating `Context`, needs to pass the following parameters:

- `projectName`: name of the project to be generated
- `templateOriginName`: The [Template Context ID](/guide/basic#template-name-resolution-rules) required to generate the project
- `config`: Dollie contextual configuration

Depended types:

- [`Config`](/api#dollieconfig)

#### `Context.prototype.generate(): GeneratorResult`

By calling this method, you can start the lifecycle of a Dollie context and finally return the project code file data generated by the Dollie generator.

Depended types:

- [`GeneratorResult`](/api#dolliegeneratorresult)

### `parseDiffToMergeBlocks(changes: DiffChange[]): MergeBlock[]`

Parse from `DiffChange` array to `MergeBlock` array.

Depended types:

- [`DiffChange`](/api#diffchange)
- [`MergeBlock`](/api#mergeblock)

### `parseFileTextToMergeBlocks(content: string): MergeBlock[]`

Parse from a string to a `MergeBlock` array.

Depended types:

- [`MergeBlock`](/api#mergeblock)

### `parseMergeBlocksToText(blocks: MergeBlock[]): string`

Parse from the `MergeBlock` array to string content.

Depended types:

- [`MergeBlock`](/api#mergeblock)

## `@dollie/origins`

### Types & Interfaces

#### `OriginMap`

Dollie origin function list, with the key as function name and the value as origin function or file path. The file path can be either a relative path to the local file system or an Internet URL.

```typescript
type OriginMap = Record<string, string | OriginHandler>;
```

Depended types:

- [`OriginHandler`](/api#dollieoriginhandler)

#### `OriginConfig`

The type passed to each origin function as a formal parameter is read and resolved by each origin function, and can be any key-value pair.

```typescript
type OriginConfig = Record<string, any>;
```

#### `OriginHandler`

The origin function, which must return the specified origin information for use by the generator.

```typescript
type OriginHandler = (
    // context ID
    id: string,
    // a configuration item defined by the function itself, which can be any key-value pair
    config: OriginConfig,
    // a `Got` instance to help the Origin function send requests
    request: Got,
) => Promise<OriginInfo>;
```

Depended types:

- [`OriginConfig`](/api#dollieoriginconfig)
- [`OriginInfo`](/api#dollieorigininfo)

#### `Origin`

Dollie origin function list item.

```typescript
interface Origin {
    // origin function name
    name: string;
    // origin function body
    handler: OriginHandler;
};
```

Depended types:

- [`OriginHandler`](/api#dollieoriginhandler)

#### `OriginInfo`

Standard, understandable origin information for Dollie generators. Used as the origin function return value.

```typescript
interface OriginInfo {
    // The final URL for the generator to pull the template
    url: string;
    // the HTTP request header used by the generator to pull the template
    headers?: OriginHeaders;
}
```

Depended types:

- [`OriginHeaders`](/api#dollieoriginheaders)

#### `OriginHeaders`

The HTTP request header used by the generator to pull the template.

```typescript
type OriginHeaders = Record<string, any>;
```

### Built-in Origin Functions

#### `github`

Configuration items:

- `token: string` Used as authentication string when the Dollie generator pulls private GitHub repositories

#### `gitlab`

Configuration items:

- `token: string` Used as authentication string when the Dollie generator pulls private GitLab repositories
- `host: string` Specify the domain name when the template is stored in a self-hosted GitLab service
- `protocol: string` When storing templates in a self-hosted GitLab service, specify the protocol type, which supports `http` and `https`.

### `loadOrigins(config: OriginMap): Promise<Origin[]>`

Loads all origin functions based on the provided Dollie origin function key-value pairs and returns data that the Dollie generator can understand.

Parameters:

- `config: OriginMap` Origin function key-value pair configuration

Return value:

`Promise<Origin[]>`

Depended types:

- [`Origin`](/api#dollieorigin)
- [`OriginMap`](/api#dollieoriginmap)

## Template Configurations

```typescript
interface TemplateConfig {
    // main template questions
    questions?: Question[];
    // main template file behavior configuration
    files?: TemplateFileConfig;
    // main template cleanup functions
    cleanups?: TemplateCleanUpFunction[];
    // extend template configurations
    extendTemplates?: ExtendTemplateConfig;
}
```

Depended types:

```typescript
// extend template configuration
type ExtendTemplateConfig = Record<string, Omit<TemplateConfig, 'extendTemplates'>>;
// cleanup functions
type TemplateCleanUpFunction = (data: TemplateCleanupData) => MergeTable;
// Dollie file behavior handler function
type DeleteConfigHandler = (
    // template configuration content
    templateConfig: TemplateConfig,
    // list of hit extension templates
    targets: string[],
) => Promise<string | string[]>;

interface TemplateFileConfig {
    merge?: string[];
    delete?: (string | DeleteConfigHandler)[];
}
```

